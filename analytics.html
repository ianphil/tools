<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --bg-card: #1a1d27;
      --bg-card-hover: #22262f;
      --border: #2a2f3a;
      --fg: #e4e4e7;
      --fg-muted: #71717a;
      --fg-dim: #52525b;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --success: #22c55e;
      --danger: #ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8fafc;
        --bg-card: #ffffff;
        --bg-card-hover: #f1f5f9;
        --border: #e2e8f0;
        --fg: #0f172a;
        --fg-muted: #64748b;
        --fg-dim: #94a3b8;
        --accent: #2563eb;
        --accent-soft: rgba(37, 99, 235, 0.1);
      }
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .auth-section {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    button {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8125rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--fg);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    button:hover {
      background: var(--bg-card-hover);
      border-color: var(--fg-dim);
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    button.primary:hover {
      filter: brightness(1.1);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .hidden { display: none !important; }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--fg-muted);
    }
    .error {
      color: var(--danger);
      padding: 1rem;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .stat-card .label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .stat-card .value {
      font-family: 'DM Mono', monospace;
      font-size: 2rem;
      font-weight: 500;
      color: var(--fg);
      line-height: 1.2;
    }
    .stat-card .value.small {
      font-size: 0.875rem;
      color: var(--fg-muted);
    }

    .section {
      margin-bottom: 2rem;
    }
    .section-header {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--fg);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-header::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th {
      text-align: left;
      padding: 0.875rem 1rem;
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--fg-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
    }
    th:last-child {
      text-align: right;
    }
    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      color: var(--fg);
    }
    td:last-child {
      text-align: right;
      font-family: 'DM Mono', monospace;
      font-size: 0.8125rem;
      color: var(--fg-muted);
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:hover td {
      background: var(--bg-card-hover);
    }
    td.page-path {
      font-family: 'DM Mono', monospace;
      font-size: 0.8125rem;
      color: var(--accent);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Blog Analytics</h1>
      <div class="auth-section">
        <button id="login-btn" class="primary">Sign in with GitHub</button>
        <button id="sync-btn" class="hidden">Sync to Gist</button>
        <button id="cleanup-btn" class="hidden">Export & Cleanup</button>
        <button id="logout-btn" class="hidden">Logout</button>
      </div>
    </header>

    <div id="loading" class="loading">Loading stats...</div>
    <div id="error" class="error hidden"></div>

    <div id="stats" class="hidden">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Total Views (30d)</div>
          <div class="value" id="total-views">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Last Updated</div>
          <div class="value small" id="generated">-</div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">Daily Views</div>
        <div class="chart-card">
          <canvas id="daily-chart" height="120"></canvas>
        </div>
      </div>

      <div class="section">
        <div class="section-header">Top Pages</div>
        <div class="table-card">
          <table>
            <thead>
              <tr><th>Page</th><th>Views</th></tr>
            </thead>
            <tbody id="pages-table"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <div class="section-header">Traffic Sources</div>
        <div class="table-card">
          <table>
            <thead>
              <tr><th>Referrer</th><th>Views</th></tr>
            </thead>
            <tbody id="referrers-table"></tbody>
          </table>
        </div>
      </div>

      <div class="section grid-2">
        <div>
          <div class="section-header">Browsers</div>
          <div class="table-card">
            <table>
              <thead>
                <tr><th>Browser</th><th>Views</th></tr>
              </thead>
              <tbody id="browsers-table"></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header">Devices</div>
          <div class="table-card">
            <table>
              <thead>
                <tr><th>Device</th><th>Views</th></tr>
              </thead>
              <tbody id="devices-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth } from './auth.js';

    const VALTOWN_BASE = 'https://ianphil--412f8d84e91f11f0bb4242dde27851f2.web.val.run';
    const VALTOWN_STATS = VALTOWN_BASE + '/stats';
    const VALTOWN_CLEANUP = VALTOWN_BASE + '/cleanup';
    const GIST_ID = 'b83195c4b3365caba7bc1104d4cc2902';

    const loginBtn = document.getElementById('login-btn');
    const syncBtn = document.getElementById('sync-btn');
    const cleanupBtn = document.getElementById('cleanup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const statsEl = document.getElementById('stats');

    function updateAuthUI() {
      if (auth.isLoggedIn()) {
        loginBtn.classList.add('hidden');
        syncBtn.classList.remove('hidden');
        cleanupBtn.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
      } else {
        loginBtn.classList.remove('hidden');
        syncBtn.classList.add('hidden');
        cleanupBtn.classList.add('hidden');
        logoutBtn.classList.add('hidden');
      }
    }

    loginBtn.onclick = () => auth.login();
    logoutBtn.onclick = () => auth.logout();

    function showError(msg) {
      loadingEl.classList.add('hidden');
      errorEl.textContent = msg;
      errorEl.classList.remove('hidden');
    }

    function renderTable(tbody, rows, keyField, isPage = false) {
      tbody.innerHTML = rows.length
        ? rows.map(r => `<tr><td${isPage ? ' class="page-path"' : ''}>${r[keyField] || '(direct)'}</td><td>${r.views}</td></tr>`).join('')
        : '<tr><td colspan="2" style="color: var(--fg-dim); text-align: center;">No data</td></tr>';
    }

    let dailyChart = null;

    function renderChart(daily) {
      const ctx = document.getElementById('daily-chart').getContext('2d');
      const sorted = [...daily].sort((a, b) => a.day.localeCompare(b.day));
      const labels = sorted.map(d => d.day.slice(5)); // MM-DD format
      const values = sorted.map(d => d.views);

      if (dailyChart) dailyChart.destroy();

      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
      const textColor = isDark ? '#71717a' : '#64748b';

      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Views',
            data: values,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: values.length < 3 ? 4 : 0,
            pointBackgroundColor: '#3b82f6',
            pointHoverRadius: 5,
            pointHoverBackgroundColor: '#3b82f6',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: isDark ? '#1a1d27' : '#fff',
              titleColor: textColor,
              bodyColor: isDark ? '#e4e4e7' : '#0f172a',
              borderColor: isDark ? '#2a2f3a' : '#e2e8f0',
              borderWidth: 1,
              padding: 10,
              cornerRadius: 6,
              displayColors: false,
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: textColor, font: { size: 11 } },
              border: { display: false }
            },
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: { color: textColor, font: { size: 11 }, precision: 0 },
              border: { display: false }
            }
          }
        }
      });
    }

    async function loadStats() {
      try {
        const res = await fetch(VALTOWN_STATS + '?days=30');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        document.getElementById('total-views').textContent = data.totals.views.toLocaleString();
        document.getElementById('generated').textContent = new Date(data.generated).toLocaleString();

        renderChart(data.daily);
        renderTable(document.getElementById('pages-table'), data.pages, 'page', true);
        renderTable(document.getElementById('referrers-table'), data.referrers, 'ref');
        renderTable(document.getElementById('browsers-table'), data.browsers, 'browser');
        renderTable(document.getElementById('devices-table'), data.devices, 'device');

        loadingEl.classList.add('hidden');
        statsEl.classList.remove('hidden');

        return data;
      } catch (e) {
        showError('Failed to load stats: ' + e.message);
        return null;
      }
    }

    syncBtn.onclick = async () => {
      syncBtn.disabled = true;
      syncBtn.textContent = 'Syncing...';

      try {
        const data = await loadStats();
        if (!data) return;

        const today = new Date().toISOString().split('T')[0];
        const datedFilename = `stats-${today}.json`;

        await auth.fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: {
              'blog-stats.json': { content: JSON.stringify(data, null, 2) },
              [datedFilename]: { content: JSON.stringify(data, null, 2) }
            }
          }),
        });

        syncBtn.textContent = 'Synced!';
        setTimeout(() => {
          syncBtn.textContent = 'Sync to Gist';
          syncBtn.disabled = false;
        }, 2000);
      } catch (e) {
        showError('Failed to sync: ' + e.message);
        syncBtn.textContent = 'Sync to Gist';
        syncBtn.disabled = false;
      }
    };

    cleanupBtn.onclick = async () => {
      const secret = prompt('Enter cleanup secret (from Val Town env):');
      if (!secret) return;

      if (!confirm('This will archive 90 days of data to Gist and delete old records. Continue?')) {
        return;
      }

      cleanupBtn.disabled = true;
      cleanupBtn.textContent = 'Exporting...';

      try {
        const res = await fetch(VALTOWN_STATS + '?days=90');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        await auth.fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: {
              'blog-stats.json': { content: JSON.stringify(data, null, 2) }
            }
          }),
        });

        cleanupBtn.textContent = 'Cleaning...';

        const cleanupRes = await fetch(VALTOWN_CLEANUP, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${secret}` },
        });

        if (!cleanupRes.ok) throw new Error(`Cleanup failed: ${cleanupRes.status}`);

        cleanupBtn.textContent = 'Done!';
        setTimeout(() => {
          cleanupBtn.textContent = 'Export & Cleanup';
          cleanupBtn.disabled = false;
          loadStats();
        }, 2000);
      } catch (e) {
        showError('Failed: ' + e.message);
        cleanupBtn.textContent = 'Export & Cleanup';
        cleanupBtn.disabled = false;
      }
    };

    updateAuthUI();
    loadStats();
  </script>
</body>
</html>
