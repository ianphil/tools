<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Analytics</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body {
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .auth-section {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--card-background-color);
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .stat-card h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.875rem;
      color: var(--muted-color);
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
    }
    table {
      margin-bottom: 1.5rem;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--muted-color);
    }
    .error {
      color: var(--del-color);
      padding: 1rem;
      background: var(--card-background-color);
      border-radius: 0.5rem;
    }
    .hidden { display: none; }
    .chart-container {
      background: var(--card-background-color);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="container">
    <h1>Blog Analytics</h1>

    <div class="auth-section">
      <button id="login-btn">Sign in with GitHub</button>
      <button id="sync-btn" class="outline hidden">Sync to Gist</button>
      <button id="cleanup-btn" class="secondary outline hidden">Export & Cleanup</button>
      <button id="logout-btn" class="secondary outline hidden">Logout</button>
    </div>

    <div id="loading" class="loading">Loading stats...</div>
    <div id="error" class="error hidden"></div>

    <div id="stats" class="hidden">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Views (30 days)</h3>
          <div class="value" id="total-views">-</div>
        </div>
        <div class="stat-card">
          <h3>Generated</h3>
          <div class="value" id="generated" style="font-size: 1rem;">-</div>
        </div>
      </div>

      <h2>Daily Views</h2>
      <div class="chart-container">
        <canvas id="daily-chart"></canvas>
      </div>

      <h2>Top Pages</h2>
      <table>
        <thead>
          <tr><th>Page</th><th>Views</th></tr>
        </thead>
        <tbody id="pages-table"></tbody>
      </table>

      <h2>Referrers</h2>
      <table>
        <thead>
          <tr><th>Source</th><th>Views</th></tr>
        </thead>
        <tbody id="referrers-table"></tbody>
      </table>

      <h2>Browsers</h2>
      <table>
        <thead>
          <tr><th>Browser</th><th>Views</th></tr>
        </thead>
        <tbody id="browsers-table"></tbody>
      </table>

      <h2>Devices</h2>
      <table>
        <thead>
          <tr><th>Device</th><th>Views</th></tr>
        </thead>
        <tbody id="devices-table"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { auth } from './auth.js';

    const VALTOWN_BASE = 'https://ianphil--412f8d84e91f11f0bb4242dde27851f2.web.val.run';
    const VALTOWN_STATS = VALTOWN_BASE + '/stats';
    const VALTOWN_CLEANUP = VALTOWN_BASE + '/cleanup';
    const GIST_ID = 'b83195c4b3365caba7bc1104d4cc2902';

    const loginBtn = document.getElementById('login-btn');
    const syncBtn = document.getElementById('sync-btn');
    const cleanupBtn = document.getElementById('cleanup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const statsEl = document.getElementById('stats');

    // Auth state
    function updateAuthUI() {
      if (auth.isLoggedIn()) {
        loginBtn.classList.add('hidden');
        syncBtn.classList.remove('hidden');
        cleanupBtn.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
      } else {
        loginBtn.classList.remove('hidden');
        syncBtn.classList.add('hidden');
        cleanupBtn.classList.add('hidden');
        logoutBtn.classList.add('hidden');
      }
    }

    loginBtn.onclick = () => auth.login();
    logoutBtn.onclick = () => auth.logout();

    function showError(msg) {
      loadingEl.classList.add('hidden');
      errorEl.textContent = msg;
      errorEl.classList.remove('hidden');
    }

    function renderTable(tbody, rows, keyField) {
      tbody.innerHTML = rows.length
        ? rows.map(r => `<tr><td>${r[keyField] || '(direct)'}</td><td>${r.views}</td></tr>`).join('')
        : '<tr><td colspan="2">No data</td></tr>';
    }

    let dailyChart = null;

    function renderChart(daily) {
      const ctx = document.getElementById('daily-chart').getContext('2d');

      // Sort by date ascending
      const sorted = [...daily].sort((a, b) => a.day.localeCompare(b.day));
      const labels = sorted.map(d => d.day);
      const values = sorted.map(d => d.views);

      if (dailyChart) {
        dailyChart.destroy();
      }

      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Views',
            data: values,
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.3,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    async function loadStats() {
      try {
        const res = await fetch(VALTOWN_STATS + '?days=30');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        document.getElementById('total-views').textContent = data.totals.views.toLocaleString();
        document.getElementById('generated').textContent = new Date(data.generated).toLocaleString();

        renderChart(data.daily);
        renderTable(document.getElementById('pages-table'), data.pages, 'page');
        renderTable(document.getElementById('referrers-table'), data.referrers, 'ref');
        renderTable(document.getElementById('browsers-table'), data.browsers, 'browser');
        renderTable(document.getElementById('devices-table'), data.devices, 'device');

        loadingEl.classList.add('hidden');
        statsEl.classList.remove('hidden');

        return data;
      } catch (e) {
        showError('Failed to load stats: ' + e.message);
        return null;
      }
    }

    syncBtn.onclick = async () => {
      syncBtn.disabled = true;
      syncBtn.textContent = 'Syncing...';

      try {
        const data = await loadStats();
        if (!data) return;

        // Create dated filename for history
        const today = new Date().toISOString().split('T')[0];
        const datedFilename = `stats-${today}.json`;

        await auth.fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: {
              'blog-stats.json': {
                content: JSON.stringify(data, null, 2)
              },
              [datedFilename]: {
                content: JSON.stringify(data, null, 2)
              }
            }
          }),
        });

        syncBtn.textContent = 'Synced!';
        setTimeout(() => {
          syncBtn.textContent = 'Sync to Gist';
          syncBtn.disabled = false;
        }, 2000);
      } catch (e) {
        showError('Failed to sync: ' + e.message);
        syncBtn.textContent = 'Sync to Gist';
        syncBtn.disabled = false;
      }
    };

    cleanupBtn.onclick = async () => {
      const secret = prompt('Enter cleanup secret (from Val Town env):');
      if (!secret) return;

      if (!confirm('This will archive 90 days of data to Gist and delete old records. Continue?')) {
        return;
      }

      cleanupBtn.disabled = true;
      cleanupBtn.textContent = 'Exporting...';

      try {
        // Fetch 90 days of stats for archive
        const res = await fetch(VALTOWN_STATS + '?days=90');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Archive to Gist
        await auth.fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: {
              'blog-stats.json': {
                content: JSON.stringify(data, null, 2)
              }
            }
          }),
        });

        cleanupBtn.textContent = 'Cleaning...';

        // Call cleanup endpoint
        const cleanupRes = await fetch(VALTOWN_CLEANUP, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${secret}` },
        });

        if (!cleanupRes.ok) throw new Error(`Cleanup failed: ${cleanupRes.status}`);

        cleanupBtn.textContent = 'Done!';
        setTimeout(() => {
          cleanupBtn.textContent = 'Export & Cleanup';
          cleanupBtn.disabled = false;
          loadStats(); // Refresh stats
        }, 2000);
      } catch (e) {
        showError('Failed: ' + e.message);
        cleanupBtn.textContent = 'Export & Cleanup';
        cleanupBtn.disabled = false;
      }
    };

    updateAuthUI();
    loadStats();
  </script>
</body>
</html>
